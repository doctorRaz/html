---
title: Фильтрация треков GPS на языке программирования F#, Часть I
date: "2019-02-21 12:00:00 +0300"
id: fsharp-gps-tracks-filtration-1
excerpt: Лекция, прочитанная в Московском клубе программистов 21 февраля 2019 года.
---

## Проблематика

На рисунке показан типичный трек, полученный с датчика GPS на мобильном телефоне во время движения.

![Фильрация треков GPS](/img/gps-track-filtering-1.png)

Чёрным цветом нарисован реальный путь автомобиля или человека, а синим&nbsp;&mdash; координаты, полученные с датчика. Как видим, пути существенно различаются. Если вы хотите вычислить скорость и пройденное расстояние, точность ваших вычислений окажется невысокой.

Мы поговорим о методах, которые помогут превратить синюю линию в красную. Красная лииня&nbsp;&mdash; это приближение, вычисленное на основании реальных синих точек.

В качестве языка реализации я выбрал F#. Во-первых потому, что это интересно. Во-вторых, написанный мной код работает и на сервере в Azure, и в мобильном Xamarin-приложении. F#, как и другие языки .NET, живёт на разных платформах.

## Данные GPS

Мобильные телефоны оснащены датчиками, которые позволяют определять положение, ориентацию и ускорение устройства. Нам для наших целей понадобятся:

1. *Широта* и *долгота* (*latitude* и *longitude*)&nbsp;&mdash; координаты устройства. Измеряются в градусах.
1. *Скорость* (*speed*). Измеряется в метрах в секунду.
1. *Направление* (*heading*)&nbsp;&mdash; направление движения относительно Севера. Измеряется в градусах, положительное направление по часовой стрелке.
1. *Метка времени* (*timestamp*)&nbsp;&mdash; дата и время получения координаты.

Опишем *объект-значение* `SensorItem`, в котором будем хранить перечисленные параметры точки:

**Types.fs**
```f#
module Types

open System

[<Struct>]
type internal SensorItem(latitude: float, longitude: float, speed: float, heading: float, timestamp: DateTimeOffset) =
    member __.Latitude = latitude
    member __.Longitude = longitude
    member __.Timestamp = timestamp
    member __.Speed = speed
    member __.Heading = heading
```

Для типов проекта создадим модуль **Types.fs**. Строка `module Types` позволит в дальнейшем использовать объявленные типы в других модулях. F# не требует, чтобы имя файла и имя модуля совпадали, но мы будем придерживаться этого соглашения.

Строке `open System` открывает для нас типы, описанные в пространстве имён `System`. Она нужна, поскольку мы используем тип `DateTimeOffset`, для которого в F# нет «родного» названия, такого, как `float`.

Мы описали структуру `SensorItem` с пятью свойствами, значения которых инициализируются в конструкторе и больше никогда не меняются. Слово *item* можно перевести на русский язык по разному, в нашей программе под *sensor item* мы понимаем *одно показание датчика*.

Поскольку состояние объекта не может быть изменено, он соответствует паттерну *объект-значение*. Мы объявили его *структурой* (`struct` в терминологии C#) с помощью атрибута `<Struct>`. Структуры прекрасно подходят для простых неизменяемых объектов.

## Этапы обработки трека

Обработка трека состоит из трёх стадий: *стабилизации*, *сглаживания* и *прореживания*. В этой заметке мы обсудим первый этап&nbsp;&mdash; стабилизацию.

Стабилизация позволяет избавиться от некорректных точек трека, либо за счёт фильтрации, либо за счёт небольшой коррекции. Этот этап необходим, чтобы *сглаживание* и *прореживание* работали корректно.

К стабилизации относятся следующие методы обработки трека:

1. Удаление нулевых и отрицательных интервалов времени.
1. Устранение дрейфа нулевой скорости.
1. Устранение всплесков скорости.

### Удаление нулевых и отрицательных интервалов времени

Для того, чтобы вычислить координаты, датчик GPS опирается на время, передаваемое со спутников. Мы не станем углубляться в теорию, просто отметим, что вместе с каждыми координатами мы получаем метку времени (timestamp).

Впрочем, накладки всё-таки возможны, и старая координата устройства может появиться в треке позже новой. Иногда две соседние координаты имеют одну и ту же метку.

В первом случае интервал времени между соседними точками отрицателен, во втором&nbsp;&mdash; равен нулю. В обоих случаях нам надо удалить координаты с отрицательными или нулевыми р



Removing Data with Duplicate/Negative Time Records.

### Устранение дрейфа нулевой скорости

Нулевая скорость должна быть нулевой, поэтому, пока автомобиль стоит на одном месте, датчик GPS должен возвращать одни и те же координаты. Логично?

Не совсем. Из-за погрешностей измерения, датчик GPS может давать близкие, но разные координаты, даже если автомобиль остановился. Скорость этих микроперемещений невысока и составляет 100-200 метров в час. Небольшое, но постоянное её изменение называется *дрифтом нулевой скорости*.

Для стабилизации, мы можем вычислять скорость микроперемещения и сравнивать её с константной, значение которой подбираем вручную. Мы можем отбрасывать слишком медленные микроперемещения, полагая, что они вызваны дрифтом нулевой скорости.

Следующий этап стабилизации&nbsp;&mdash; *устранение дрейфа нулевой скорости*. Когда автомобиль длительное время стоит на одном месте, датчик GPS продолжает получать координаты

На третьем этапе процесса фильтрации устраняется эффект, называемый дрейфом с нулевой скоростью. Дрейф нулевой скорости появляется, когда GPS DAS работает, и автомобиль останавливается и работает на холостом ходу в течение длительного периода времени. Во время событий простоя длительной длительности регистраторы данных GPS часто регистрируют очень малое значение скорости (0,1 или 0,2 мили в час) из-за повторного получения спутникового сигнала GPS, которое происходит при остановке транспортного средства. Чтобы устранить небольшие колебания скорости автомобиля, зарегистрированные GPS DAS в течение этих периодов, дрейфовый фильтр с нулевой скоростью проверяет расстояние, пройденное за каждую микротрип в цикле движения, и сравнивает значение с заданным пользователем пределом. Если расстояние, пройденное по микротрипу, меньше предела, вся микротрип заменяется значениями данных нулевой скорости.

## Ссылки

[^1] [GPS Data Filtration Method for Drive Cycle Analysis Applications](https://pdfs.semanticscholar.org/3bc3/3f0902565a19a016762ab07ace62a7ca0261.pdf)

[^2] [Фильтр Калмана](https://habr.com/ru/post/166693/)
