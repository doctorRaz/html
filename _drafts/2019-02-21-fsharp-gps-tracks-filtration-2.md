---
title: Фильтрация треков GPS на языке программирования F#
date: "2019-02-21 12:00:00 +0300"
id: fsharp-gps-tracks-filtration
excerpt: Лекция, прочитанная в Московском клубе программистов 21 февраля 2019 года.
---


### Устранение дрейфа нулевой скорости

Нулевая скорость должна быть нулевой, поэтому, пока автомобиль стоит на одном месте, датчик GPS должен возвращать одни и те же координаты. Логично?

Не совсем. Из-за погрешностей измерения, датчик GPS может давать близкие, но разные координаты, даже если автомобиль остановился. Скорость этих микроперемещений невысока и составляет 100-200 метров в час. Небольшое, но постоянное её изменение называется *дрифтом нулевой скорости*.

Для стабилизации, мы можем вычислять скорость микроперемещения и сравнивать её с константной, значение которой подбираем вручную. Мы можем отбрасывать слишком медленные микроперемещения, полагая, что они вызваны дрифтом нулевой скорости.

Следующий этап стабилизации&nbsp;&mdash; *устранение дрейфа нулевой скорости*. Когда автомобиль длительное время стоит на одном месте, датчик GPS продолжает получать координаты

На третьем этапе процесса фильтрации устраняется эффект, называемый дрейфом с нулевой скоростью. Дрейф нулевой скорости появляется, когда GPS DAS работает, и автомобиль останавливается и работает на холостом ходу в течение длительного периода времени. Во время событий простоя длительной длительности регистраторы данных GPS часто регистрируют очень малое значение скорости (0,1 или 0,2 мили в час) из-за повторного получения спутникового сигнала GPS, которое происходит при остановке транспортного средства. Чтобы устранить небольшие колебания скорости автомобиля, зарегистрированные GPS DAS в течение этих периодов, дрейфовый фильтр с нулевой скоростью проверяет расстояние, пройденное за каждую микротрип в цикле движения, и сравнивает значение с заданным пользователем пределом. Если расстояние, пройденное по микротрипу, меньше предела, вся микротрип заменяется значениями данных нулевой скорости.

## Ссылки

[^1] [GPS Data Filtration Method for Drive Cycle Analysis Applications](https://pdfs.semanticscholar.org/3bc3/3f0902565a19a016762ab07ace62a7ca0261.pdf)

[^2] [Фильтр Калмана](https://habr.com/ru/post/166693/)


## Фильтр Калмана

### Введение

Рассмотрим задачу движения автомобиля в одномерном пространстве.

Нам известна координата автомобиля в текущий момент времени, обозначим её *xʳᵢ*. Буква *r* означает, что мы берём реальную (real) координату. Сенсор возвращает нам скорость автомобиля в точке *xʳᵢ*, обозначим её *uˢᵢ*. Здесь буква *s* означает, что скорость получена с сенсора. Через некоторое время, традиционно обозначаемое Δt (дельта тэ), автомобиль попадёт в точку *xʳᵢ₊₁*:

*xʳᵢ₊₁* = *xʳᵢ* + *uˢᵢ* × *Δt*

Эта модель движения работает с погрешностью, поскольку не учитывает ускорения и других факторов. Вместо усложения и уточнения модели мы явно обозначим разницу греческой буквой *кси*, как часто обозначают случайные величины. Конечно, погрешность не является случайной величиной, но мы можем считать её таковой. Так иногда делают в физике, чтобы упростить расчёты. Запишем формулу определения следующей координаты с учётом погрешности:

*xʳᵢ₊₁* = *xʳᵢ* + *uˢᵢ* × *Δt* + *ξᵢ*

Индекс *i* у буквы *кси* означает, что погрешности в каждой точке измерения будут разными.

Если мы измеряем расстояние в метрах, то значение погрешности также будет в метрах, например, +0,5 метра или -0,3 метра. У нас много значений погрешности, поэтому мы можем посчитать *среднее*&nbsp;&mdash; *Eξ*. *E* это сокращение от *expectation*, то есть *ожидание*. *Математическое ожидание*&nbsp;&mdash; другое название для среднего.

*Eξ* = (*ξ₁* + *ξ₂* + ... + *ξₙ*)/*n*

> Если у нас хорошая модель, математическое ожидание погрешности будет равным нулю: все положительные ошибки нивелируются отрицательными. В дальнейшем мы предполагаем, что речь идёт о хорошей модели и *Eξ* = 0.

Кроме ожидания случайная величина характеризиуется разбросом, то есть тем, насколько далеко она находится от среднего значения. Традиционно мерой разброса является *дисперсия*, которая обозначается маленькой буквой *сигма*:

*σ<sub>ξ</sub>*² = *E*(*ξ* - *Eξ*)²

*σ<sub>ξ</sub>*&nbsp;&mdash; *среднеквадратичное отклонение*, *стандартное отклонение* или *стандартный разброс*. Вычисляется, как квадратный корень из дисперсии.

Подключим к нашей машине GPS-трекер, который будет возвращать её координату. Поскольку сенсор работает с погрешностью, координата сенсора будет отличаться от реальной координаты на случайную величину, которую мы обозначим греческой буквой *эта*.

*xˢᵢ₊₁* = *xʳᵢ₊₁* + *ηᵢ₊₁*

Здесь *xʳᵢ₊₁*&nbsp;&mdash; истинное значение координаты, а *ηᵢ₊₁*&nbsp;&mdash; случайная погрешность сенсора.

> Как и в случае с моделью, мы предполагаем, что математическое ожидание погрешности сенсора равно 0: *Eη* = 0.

### Постановка задачи

Предположим, мы находимся где-то в середине пути, в точке *i*. Предположим, мы вычислили координату *x* в *i*-той точке, *xᵃᵢ*.
Буква *a* означает *approximation*, то есть *приближение*.

Сенсор возвращает нам текущую координату *xˢᵢ* и сокрость *uˢᵢ*.

Через время Δt мы получаем с сенсора координату *xˢᵢ₊₁*.

Опираясь на модель, мы можем предсказать следующую координату: *xᵃᵢ + *uˢᵢ* × *Δt*.

Предполагается, что следующая координата, которую мы вычислим, находится где-то между предсказанной и полученной с сенсора. Задача нахождения значения функции внутри интервала назыается *интерполяцией*. Простейшая интерполяция&nbsp;&mdash; *линейная*.

*xᵃᵢ₊₁* = *K* × *xˢᵢ₊₁* + (1 - *K*) × (*xᵃᵢ + *uˢᵢ* × *Δt*)

Здесь *K*&nbsp;&mdash; это коэффициент Калмана, который показывает, какой *вес* имеют показания сенсора. Если вес сенсора равен 30%, то вес модели 70%. Значение коэффициента находится в интервале от 0 до 1 включительно.

*Ошибкой предсказания* назовём разницу между *xʳᵢ₊₁* и *xᵃᵢ₊₁*:

*eᵢ₊₁* + *xʳᵢ₊₁* - *xᵃᵢ₊₁*

Наша задача&nbsp;&mdash; минимизировать ошибку. Если взглянуть на формулу вычисления *xᵃᵢ₊₁*, мы видим, что для минимизации ошибки мы можем управлять значением коэффициента *K*.

Мы будем минимизировать дисперсию ошибки то есть *E*(*e*<sup>2</sup><sub>i + 1</sub>)

## Методы стабилизации трека

### Удаление нулевых и негативных интервалов времени

Removing Data with Duplicate/Negative Time Records.

### Устранение дрейфа нулевой скорости

Нулевая скорость должна быть нулевой, поэтому, пока автомобиль стоит на одном месте, датчик GPS должен возвращать одни и те же координаты. Логично?

Не совсем. Из-за погрешностей измерения, датчик GPS может давать близкие, но разные координаты, даже если автомобиль остановился. Скорость этих микроперемещений невысока и составляет 100-200 метров в час. Небольшое, но постоянное её изменение называется *дрифтом нулевой скорости*.

Для стабилизации, мы можем вычислять скорость микроперемещения и сравнивать её с константной, значение которой подбираем вручную. Мы можем отбрасывать слишком медленные микроперемещения, полагая, что они вызваны дрифтом нулевой скорости.

Следующий этап стабилизации&nbsp;&mdash; *устранение дрейфа нулевой скорости*. Когда автомобиль длительное время стоит на одном месте, датчик GPS продолжает получать координаты

На третьем этапе процесса фильтрации устраняется эффект, называемый дрейфом с нулевой скоростью. Дрейф нулевой скорости появляется, когда GPS DAS работает, и автомобиль останавливается и работает на холостом ходу в течение длительного периода времени. Во время событий простоя длительной длительности регистраторы данных GPS часто регистрируют очень малое значение скорости (0,1 или 0,2 мили в час) из-за повторного получения спутникового сигнала GPS, которое происходит при остановке транспортного средства. Чтобы устранить небольшие колебания скорости автомобиля, зарегистрированные GPS DAS в течение этих периодов, дрейфовый фильтр с нулевой скоростью проверяет расстояние, пройденное за каждую микротрип в цикле движения, и сравнивает значение с заданным пользователем пределом. Если расстояние, пройденное по микротрипу, меньше предела, вся микротрип заменяется значениями данных нулевой скорости.

## Ссылки

[^1] [GPS Data Filtration Method for Drive Cycle Analysis Applications](https://pdfs.semanticscholar.org/3bc3/3f0902565a19a016762ab07ace62a7ca0261.pdf)

[^2] [Фильтр Калмана](https://habr.com/ru/post/166693/)
